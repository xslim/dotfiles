#!/bin/bash

CHEAT_PATH=${HOME}/.cheats

list_pages() {
  IFS=":"
  local paths="$CHEAT_PATH"

  echo
  printf "  \033[1m pages:\033[0m\n"
  echo
  for path in $paths; do
    test ! -z $path \
      && test -d $path \
      && find $path -type f \
      | xargs -n1 basename \
      | grep -iv 'readme*' \
      | grep '.md$' \
      | perl -pe 's|^(.*)\.md$|    \1|;'
  done
  echo
}

edit() {
  IFS=":"
  local page=$1
  local paths=".:$CHEAT_PATH"

  for path in $paths; do
    local file=$path/$page
    local ext=$path/$page.md
    [[ -f "$file" ]] && edit_file $file
    [[ -f "$ext" ]]  && edit_file $ext
  done

  echo "Creating $page"
  vim "${CHEAT_PATH}/${page}.md"
}

display() {
  IFS=":"
  local page=$1
  local paths=".:$CHEAT_PATH"

  for path in $paths; do
    local file=$path/$page
    local ext=$path/$page.md
    [[ -f "$file" ]] && display_file $file
    [[ -f "$ext" ]]  && display_file $ext
  done

  echo
  echo "  Failed to locate '$page'"
  echo
  echo "    CHEAT_PATH=\"$paths\""
  echo
  exit 1
}

display_from_stdin() {
  display_file <(cat)
}

display_file() {
  local heading=1m
  local code=90m
  local strong=1m
  local em=4m

  < "$1" perl -pe "
      s|^#+ *(.+)|\e[$heading\1\e[0m|g; \
      s|\`(.+?)\`|\e[$code\1\e[0m|g; \
      s|\*\*(.+?)\*\*|\e[$strong\1\e[0m|g; \
      s|__(.+?)__|\e[$strong\1\e[0m|g; \
      s|\*(.+?)\*|\e[$em\1\e[0m|g; \
      s|_(.+?)_|\e[$em\1\e[0m|g; \
      s|^\s{0,2}[\*\|-]\s(.+?)\s-\s|\t\e[$strong\1\t- \e[0m|g; \
      s|    (.+)|    \e[$code\1\e[0m|g; \
      s|<(.+?)>||g; \
      s|^|  |;" \
    | less -R
  exit
}

edit_file() {
  vim $1
}

case $1 in
  -l|--list|ls|list)
    list_pages
    ;;
  -)
    display_from_stdin
    ;;
  -e)
    edit $2
    ;;
  *)
    display $1
    ;;
esac
